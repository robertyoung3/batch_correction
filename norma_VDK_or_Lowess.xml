<tool id="Batch_correction" name="Batch_correction" version="2014-04-24">
	<description>Correct analytical effects on intensities</description>
	<command interpreter="perl">
       norma_VDK_or_Lowess.pl
	       -dataMatrix $dataMatrix -sep1 "tabular"
	       -sampleMetadata $sampleMetadata -sep2 "tabular"
	       -variableMetadata $variableMetadata -sep3 "tabular"
	       -ref_factor $ref_factor -detail $detail -method $method
	       -dataMatrix_out $dataMatrix_out -variable_for_simca $combinedResults -variableMetadata_out $variableMetadata_out
	       -graph_output $graph_output  -rdata_output $rdata_output
	</command>
	<inputs>
		<param name="dataMatrix" label="Data Matrix file " format="tabular" type="data" />
		<param name="sampleMetadata" label="Sample metadata file " format="tabular" type="data" help="must have at least the three following columns : 'batch' + 'injectionOrder' + 'sampleType'"/>
		<param name="variableMetadata" label="Variable metadata file " format="tabular" type="data" />
		
		<param name="ref_factor" label="Factor of interest " type="text"  value="batch" help="column name of factor of interest (often a biological factor) ; if none, leave 'batch'" />
		<param name="method" label="Type of regression model " type="select" help="Select between linear or non-linear (lowess or loess) which one to be used in Van der Kloet algorithm.">
			<option value="linear">linear</option>
			<option value="lowess">lowess</option>
			<option value="loess">loess</option>
		</param>
		<param name="detail" label="Level of details for plots " type="select" help="Amount of plots in the pdf file output. See Help section for more details.">
			<option value="no">basic</option>
			<option value="plot">standard</option>
			<option value="reg">complete</option>
		</param>
	</inputs>
	
	<outputs>
		<data name="combinedResults" label="${tool.name}_${method}_combined_results" format="tabular"/>
		<data name="dataMatrix_out" label="${tool.name}_${method}_${dataMatrix.name}" format="tabular"/>
		<data name="variableMetadata_out" label="${tool.name}_${method}_${variableMetadata.name}" format="tabular"/>
		<data name="graph_output" label="${tool.name}_${method}_graph" format="pdf"/>
		<data name="rdata_output" label="${tool.name}_${method}_rdata" format="rdata"/>
	</outputs>
	<help>

.. class:: infomark

**Authors** Franck Giacomoni and Marion Landi (for interface and wrapper) and Jean-Francois Martin and Melanie Petera (for R)

---------------------------------------------------

.. class:: infomark

**Please cite** If you use this tool, please cite `F.M. Van Der Kloet, I. Bobeldijk, E.R. Verheij, R.H. Jellema. (2009). "Analytical error reduction using single point calibration for accurate and precise metabolomic phenotyping." Journal of Proteome Research p5132-5141 &lt;http://www.ncbi.nlm.nih.gov/pubmed/19754161&gt;`_

---------------------------------------------------

================
Batch_correction
================

-----------
Description
-----------

| Correction of analytical effects inter and intra batch on intensities using quality control pooled samples (QC-pools)
| according to the algorithm mentioned by Van der Kloet (J Prot Res 2009).

 
-----------------
Workflow position
-----------------


.. image:: ./static/images/metabolomics/batch_correction.png
        :width: 800


-----------
Input files
-----------

+----------------------------+------------+
| Parameter : num + label    |   Format   |
+============================+============+
| 1 : Data Matrix file       |   tabular  |
+----------------------------+------------+
| 2 : Sample metadata file   |   tabular  |
+----------------------------+------------+
| 3 : Variable metadata file |   tabular  |
+----------------------------+------------+


Data Matrix file must contain the intensity values of variables.
	| First line must contain all the samples names
	| First column must contain all the variables id

Sample metadata file must have at least the three following columns : 
	* "batch" to identify the batches of analyses ; need at leat 3 pools for linear adjustment and 8 for lo(w)ess adjustment
	* "injectionOrder" integer defining the injection order of all samples : QC-pools and analysed samples
	* "sampleType" indicate if defining a samples or a pool


.. class:: warningmark

NO MISSING DATA are allowed


----------
Parameters
----------

Factor of interest
	| factor name (column header) that will be used as a categorical variable for plots and PCA.
	| (often a biological factor ; if none, leave “batch”)
	| This factor does not affect correction calculation.
	| 

Type of regression model :
	| To choose between *linear*, *lowess* and *loess* regression.
	| Define which model type should be used in Van der Kloet correction algorithm concerning QC-pools regression.
	|

Level of details for plots
	| *basic* : PCA + CV boxplot (before and after correction)
	| *standard* : 'basic' plots + before/after-correction plots of intensities and design effects for each ion
	| *complete* : 'standard' plots + QC-pools regression plots per batch with samples intensities
	|


------------
Output files
------------

Batch_correction_$method_rdata.rdata
	| binary data
	| Download, open with R and send res
	|

Batch_correction_$method_graph.pdf
	| plot output
	| graphical view
	|

Batch_correction_$method_variableMetadata.tabular
	| tsv output
	| Identical to the Variable metadata input file with x more columns (where x is the number of batches)
	|

Batch_correction_$method_dataMatrix.tabular
	| tsv output
	| tabulated for other uses
	| same formatting as Data Matrix file
	|

Batch_correction_$method_combined_results.tabular
	| tsv output
	| tabulated for use by SIMCA
	| same formatting as Sample metadata file + transposed to the formatting of Data Matrix file
	|
	
---------------------------------------------------

---------------
Working example
---------------


.. class:: warningmark

Soon see the corresponding "Page"


  </help>


Input files
===========

| **These two input files can be used in the purview "URL/Text:" of the tool "Get Data/Upload File",**
| **by checking the box "Convert spaces to tabs: YES"**

Metadata_samples.txt
	Model input Sample metadata file::

		samples idLIMS serie factor01 factor02 batch injectionOrder sampleType
		POOL1 POOL1 p p p 01_08_2011 1 p
		X12588 12588 3 validation 2 01_08_2011 2 s
		X17736 17736 3 Q1 1 01_08_2011 3 s
		X15432 15432 3 validation 1 01_08_2011 4 s
		X17159 17159 3 Q4 1 01_08_2011 5 s
		X14325 14325 3 validation 2 01_08_2011 6 s
		X17419 17419 3 Q4 1 01_08_2011 7 s
		X16437 16437 3 Q4 1 01_08_2011 8 s
		X16172 16172 3 Q4 2 01_08_2011 9 s
		X16392 16392 3 Q4 2 01_08_2011 10 s
		X13875 13875 3 validation 2 01_08_2011 11 s
		POOL2 POOL2 p p p 01_08_2011 12 p
		X13117 13117 3 Q4 2 01_08_2011 13 s
		X13341 13341 3 Q1 2 01_08_2011 14 s
		X16888 16888 3 Q4 1 01_08_2011 15 s
		X17489 17489 3 Q4 2 01_08_2011 16 s
		X12718 12718 3 Q1 2 01_08_2011 17 s
		X16235 16235 3 Q4 2 01_08_2011 18 s
		X16878 16878 3 Q1 1 01_08_2011 19 s
		X12701 12701 3 validation 1 01_08_2011 20 s
		X16220 16220 3 Q4 2 01_08_2011 21 s
		X15635 15635 3 Q4 1 01_08_2011 22 s


Intensity_matrix.txt
	Model input Matrix Ions file BEFORE IMPLEMENTATION::

		samples POOL1 X12588 X17736 X15432 X17159 X14325 X17419 X16437 X16172 X16392 X13875 POOL2 X13117 X13341 X16888 X17489 X12718 X16235 X16878 X12701 X16220 X15635
		ion01 188.4140625 219.729126 122.5697632 123.5487671 805.8852539 183.4683838 37.33084106 151.8625488 97.12005615 91.24694824 69.87762451 195.4349365 112.4111938 136.7092285 159.9987793 172.1585693 0 117.5420532 133.6679688 80.05419922 160.0006104 760.0488281
		ion02 82.02575684 87.11358643 79.82391357 80.33862305 83.08575439 94.27703857 76.02288818 77.04394531 76.97564697 84.17669678 81.04943848 86.44024658 84.11865234 83.71282959 77.75219727 79.15936279 75.98492432 78.2835083 78.98760986 73.98388672 72.20550537 82.16448975
		ion03 25.31900024 24.2960968 23.29342651 31.54063416 30.3830719 22.42404175 35.44485474 26.38783264 17.1401825 21.27339172 20.25959778 26.33859253 18.17146301 26.32852173 24.30648804 28.34313965 29.37016296 18.23519897 24.48402405 25.38140869 24.35777283 21.31071472
		ion04 65.87536621 62.68716431 46.60232544 62.77856445 29.53218079 47.59136963 90.13983154 28.35336304 58.74325562 31.39331055 23.32928467 30.39666748 41.43960571 21.27049255 88.1161499 29.36820984 24.30200195 25.00007629 45.60662842 103.293457 37.46994019 87.09295654
		ion05 0 103.728544 279.5808214 884.2333448 824.5072072 434.6439081 764.82768 799.0972595 398.4002569 382.5370891 74.55342827 0 636.6596277 514.3863309 741.690017 412.3166491 660.8996555 57.36593795 102.2085264 455.6403091 548.6145486 515.8412195
		ion06 2711.785156 3465.292969 2469.75 3435.259766 2482.3125 2593.654297 1407.915039 1291.253906 2241.734375 1444.189453 3363.683594 2578.642578 2633.181641 3397.763672 3706.855469 3647.212891 3548.410156 3714.640625 1889.213867 2262.707031 2107.417969 2763.21875
		ion07 164.9023438 192.40625 140.7609863 192.4053955 139.7540283 140.748291 84.60144043 86.1819458 150.762207 89.90411377 207.5949707 164.0512695 149.8706055 186.336792 214.6140137 202.5360107 214.6877441 195.4482422 117.4679565 127.2941895 142.78479 163.0666504


Parameters
==========

Factor analysis  -> **batch**

Level of details  -> **no**

Model used (linear or not)  -> **Linear**


Output files
============

Norma_rdata_$detail.rdata::

	binary data
	Download, open with R send res


Norma_plots_$detail.pdf

.. image:: ./static/images/metabolomics/Vdk_pdf1.png
        :width: 800
        
.. image:: ./static/images/metabolomics/Vdk_pdf2.png
        :width: 800
        

Norma_result_for_simca.tabular::

	samples	idLIMS	serie	factor01	factor02	batch	injectionOrder	sampleType	ion01	ion02	ion03	ion04	ion05	ion06	ion07
	POOL1	POOL1	p	p	p	01_08_2011	1	p	183.806309736177	78.555522674121	24.2565782732588	67.2059357441544	0	2756.58450391724	158.052416850832
	POOL2	POOL2	p	p	p	01_08_2011	12	p	190.655485025641	82.783250185879	25.2333869921957	31.0106280849366	0	2621.24237826457	157.236695576441
	X12588	12588	3	validation	2	01_08_2011	2	s	220.281338788057	87.500123119505	24.4029802274792	62.5632990312483	94.2986763636364	3459.67039593807	193.243760535699
	X12701	12701	3	validation	1	01_08_2011	20	s	80.2553876257053	74.3121648660553	25.4930666232626	103.089356639338	414.218462818182	2259.03570054876	127.848278698451
	X12718	12718	3	Q1	2	01_08_2011	17	s	0	76.3220813847312	29.4993682273574	24.2539829611226	600.817868636364	3542.65272205883	215.622242057156
	X13117	13117	3	Q4	2	01_08_2011	13	s	112.693700265425	84.4919000357226	18.251402938821	41.3577240621519	578.781479727273	2628.90920103769	150.522965863022
	X13341	13341	3	Q1	2	01_08_2011	14	s	137.052799630498	84.0842765863284	26.4443462044465	21.2284636032788	467.623937181818	3392.25066785752	187.147883253472
	X13875	13875	3	validation	2	01_08_2011	11	s	70.0532376321925	81.4090675909135	20.3487238346046	23.2831876997425	67.7758438818182	3358.22588611392	208.498595063134
	X14325	14325	3	validation	2	01_08_2011	6	s	183.929467815501	94.695360623753	22.5226896299416	47.497332543935	395.130825545454	2589.44599169574	141.360943533866
	X15432	15432	3	validation	1	01_08_2011	4	s	123.859263984884	80.6950981610103	31.6793877676942	62.6545185712173	803.848495272727	3429.68592298187	193.242902316211
	X15635	15635	3	Q4	1	01_08_2011	22	s	761.958946663093	82.5290665188414	21.4044648499099	86.9208671903241	468.946563181818	2758.73531975414	163.776450823485
	X16172	16172	3	Q4	2	01_08_2011	9	s	97.3641336556051	77.3172000270102	17.2155856179699	58.6271832180619	362.182051727273	2238.0970735015	151.418448347397
	X16220	16220	3	Q4	2	01_08_2011	21	s	160.402716323636	72.5258925581935	24.4649275827679	37.3959023125888	498.740498727273	2103.99860111142	143.406307055514
	X16235	16235	3	Q4	2	01_08_2011	18	s	117.83745429722	78.6308645435113	18.315419286157	24.950677956983	52.1508526818182	3708.61347563638	196.298993992243
	X16392	16392	3	Q4	2	01_08_2011	10	s	91.4762657301598	84.5502020280356	21.3669776585093	31.3312796509314	347.760990090909	1441.84619925857	90.295450550822
	X16437	16437	3	Q4	1	01_08_2011	8	s	152.244202534309	77.3858014174909	26.5039180350956	28.2973388561794	726.452054090909	1289.1587961513	86.5570806388865
	X16878	16878	3	Q1	1	01_08_2011	19	s	134.003896781277	79.3380903129169	24.5917342073347	45.5165130382572	92.9168421818182	1886.14854378149	117.979273835979
	X16888	16888	3	Q4	1	01_08_2011	15	s	160.400880621802	78.0971960028743	24.4134171806386	87.9420387946402	674.263651818182	3700.84095135577	215.548190721704
	X17159	17159	3	Q4	1	01_08_2011	5	s	807.910566388206	83.4544189550015	30.5167331579687	29.4738273480161	749.552006545455	2478.28485110605	140.362352983359
	X17419	17419	3	Q4	1	01_08_2011	7	s	37.4246591541122	76.3602136963513	35.6007838010462	89.9617217868595	695.297890909091	1405.63064191075	84.9696956072378
	X17489	17489	3	Q4	2	01_08_2011	16	s	172.59123002765	79.510605337691	28.4678268347873	29.3101803926911	374.833317363636	3641.2951457659	203.417614300817
	X17736	17736	3	Q1	1	01_08_2011	3	s	122.877799698849	80.1781048340628	23.3958989887532	46.5102426333419	254.164383090909	2465.74273425251	141.373694094272


Norma_result.tabular::

	POOL1	POOL2	X12588	X12701	X12718	X13117	X13341	X13875	X14325	X15432	X15635	X16172	X16220	X16235	X16392	X16437	X16878	X16888	X17159	X17419	X17489	X17736
	ion01	183.806309736177	190.655485025641	220.281338788057	80.2553876257053	0	112.693700265425	137.052799630498	70.0532376321925	183.929467815501	123.859263984884	761.958946663093	97.3641336556051	160.402716323636	117.83745429722	91.4762657301598	152.244202534309	134.003896781277	160.400880621802	807.910566388206	37.4246591541122	172.59123002765	122.877799698849
	ion02	78.555522674121	82.783250185879	87.500123119505	74.3121648660553	76.3220813847312	84.4919000357226	84.0842765863284	81.4090675909135	94.695360623753	80.6950981610103	82.5290665188414	77.3172000270102	72.5258925581935	78.6308645435113	84.5502020280356	77.3858014174909	79.3380903129169	78.0971960028743	83.4544189550015	76.3602136963513	79.510605337691	80.1781048340628
	ion03	24.2565782732588	25.2333869921957	24.4029802274792	25.4930666232626	29.4993682273574	18.251402938821	26.4443462044465	20.3487238346046	22.5226896299416	31.6793877676942	21.4044648499099	17.2155856179699	24.4649275827679	18.315419286157	21.3669776585093	26.5039180350956	24.5917342073347	24.4134171806386	30.5167331579687	35.6007838010462	28.4678268347873	23.3958989887532
	ion04	67.2059357441544	31.0106280849366	62.5632990312483	103.089356639338	24.2539829611226	41.3577240621519	21.2284636032788	23.2831876997425	47.497332543935	62.6545185712173	86.9208671903241	58.6271832180619	37.3959023125888	24.950677956983	31.3312796509314	28.2973388561794	45.5165130382572	87.9420387946402	29.4738273480161	89.9617217868595	29.3101803926911	46.5102426333419
	ion05	0	0	94.2986763636364	414.218462818182	600.817868636364	578.781479727273	467.623937181818	67.7758438818182	395.130825545454	803.848495272727	468.946563181818	362.182051727273	498.740498727273	52.1508526818182	347.760990090909	726.452054090909	92.9168421818182	674.263651818182	749.552006545455	695.297890909091	374.833317363636	254.164383090909
	ion06	2756.58450391724	2621.24237826457	3459.67039593807	2259.03570054876	3542.65272205883	2628.90920103769	3392.25066785752	3358.22588611392	2589.44599169574	3429.68592298187	2758.73531975414	2238.0970735015	2103.99860111142	3708.61347563638	1441.84619925857	1289.1587961513	1886.14854378149	3700.84095135577	2478.28485110605	1405.63064191075	3641.2951457659	2465.74273425251
	ion07	158.052416850832	157.236695576441	193.243760535699	127.848278698451	215.622242057156	150.522965863022	187.147883253472	208.498595063134	141.360943533866	193.242902316211	163.776450823485	151.418448347397	143.406307055514	196.298993992243	90.295450550822	86.5570806388865	117.979273835979	215.548190721704	140.362352983359	84.9696956072378	203.417614300817	141.373694094272

</tool>
